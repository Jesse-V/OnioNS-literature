\documentclass[journal]{IEEEtran}
\usepackage{graphicx,mathtools,epstopdf,epsfig,pdflscape,hyperref}
\usepackage[T1]{fontenc}
\DeclarePairedDelimiter{\floor}{\lfloor}{\rfloor}

\begin{document}

\title{EsgalDNS: Tor-powered Distributed DNS \\ for Tor Hidden Services}
\author{Jesse Victors \\ October 2014}

\maketitle

\section{Abstract}

Tor is a second-generation onion routing system that aims to provide anonymity, privacy, and Internet censorship resistance to its users. In recent years it has grown significantly in response to revelations of national and global electronic surveillance, and remains one of the most popular and secure anonymity network in use today. While it used most often for accessing the clearnet, Tor also supports anonymous websites within its network. Decentralized and secure, the domain names for these services are tied to public key infrastructure but are challenged by their long and technical addresses. In response to this difficulty, I propose a decentralized DNS system that is embedded in the Tor network. This system provides a securely unique mapping between human-readable names and traditional Tor hidden service addresses. This paper serves as a brief overview and initial rough draft of this proposal.

\section{Background}

\subsection{Overview of Tor}

Tor has been recognized by the NSA as the "the king of high secure, low latency Internet anonymity". The term Tor refers both to the client-side multiplexing software and to the worldwide volunteer-run network of over six thousand nodes. The Tor software provides an anonymity and privacy layer by relaying all end-user TCP traffic through a series of relays on the Tor network. Typically this route consists of a carefully-constructed three-hop path known as a \textit{circuit}, which changes over time. These nodes in the circuit are commonly referred to as \textit{guard node}, \textit{middle relay}, and the \textit{exit node}, respectively. Only the first node is exposed to the origin of TCP traffic into Tor, and only the exit node can see the destination of traffic out of Tor. The middle router, which passes encrypted traffic between the two, is unaware of either. The client negotiates a separate TLS connection with each node at a time, and traffic through the circuit is decrypted one layer at a time. This makes Tor much more resilient to traffic analysis in comparison to a VPN or to a direct TLS connection.

\begin{figure}[htbp]
	\centering
	\includegraphics[width=0.5\textwidth]{../images/onion_layers.eps}
	\caption{Construction of a Tor circuit and a torified web GET request}
	\label{fig:figure3}
\end{figure}

The Tor network is managed by nine authority nodes. All nodes in the Tor network periodically send status reports to these authorities. The authority nodes in turn broadcast to the Tor network a digitally signed list containing IPs, ports, public keys, status, capabilities, and other information about all nodes on the network. Thus the Tor network is a interconnected graph.

\subsection{Tor Hidden Services}

While Tor is most frequently used to anonymously or privately access the Internet, it also supports anonymous services such as websites, marketplaces, and chatrooms. Tor hidden services are a part of the Dark Web and cannot be normally contacted outside of Tor. They allow a client, Alice, and a hidden service, Bob, to communicate with bidirectionally anonymously. Tor does not contain a DNS system for its hidden services; instead, services are accessed by hexadecimal identifiers. Every hidden service contains a public and private RSA key pair and its domain name is a truncated hash of its public key with the top-level domain (TLD) as .onion.

The hidden service Bob enables communication by first building Tor circuits to several random relays. He then tells them his public key, $ B_{K} $, enabling them to act as \textit{introduction points} for his services. He digitally signs a list of these introduction points and uploads the list to a distributed hash table inside the Tor network. A client Alice with Bob's hexadecimal domain name can initiates contact by first querying this hashtable for $ B_{K} $ and Bob's introduction points. She can verify that the domain name she queried is a truncated hash of $ B_{K} $, which allows her to prove Bob's authenticity. Secondly, she builds a circuit to random relay, $ RP $, and enables to act as a rendezvous point by telling it a one-time secret, $ S $. Third, Alice builds a Tor circuit to one of Bob's introduction points, $ IP_{1} $, and sends it a cookie encrypted with $ B_{K} $, containing $ RP $ and $ S $. Bob decrypts this message, builds a circuit to $ RP $, and tells it $ S $, enabling Alice and Bob to communicate. Their communication travels through six Tor nodes: three established by Alice and three by Bob, so both parties remain anonymous.

\subsection{Zooko's Triangle}

Zooko's Triangle is an influential conjecture proposed by Zooko Wilcox-O'Hearn in late 2001. The conjecture states that in a persistent naming system, only two out of the three following properties can be established:\cite{Ferdous2009}

\begin{itemize}
  \item Human meaningfulness: the names have a quality of meaningfulness and memorability to the users. 
  \item Securely one-to-one: each name is unique, corresponds to a unique entity or owner, and cannot be forged.
  \item Distributed: the naming system lacks a central authority or database for allocating and distributing names.
\end{itemize}

\begin{figure}[htbp]
	\centering
	\includegraphics[width=0.3\textwidth]{../images/Zooko.eps}
	\caption{Zooko's Triangle.}
	\label{fig:figure8}
\end{figure}

For example, Tor hidden service .onion addresses and Bitcoin addresses are secure and decentralized but are not human-meaningful. Internet domain names are memorable and provably collision-free, but use central database managed DNS under the jurisdiction of ICANN. Finally, human nicknames are meaningful and distributed, but not securely collision-free.\cite{Stiegler2005}

In recent years, systems have been developed that have shown Zooko's Triangle to be false. One prominent example is Namecoin, a naming system which uses a Bitcoin-like blockchain to store name-value pairs. Human-meaningful names can be embedded in the blockchain, which is distributed by nature. The uniqueness of the names is ensured by the Namecoin network and can be verified with anyone holding the blockchain. However, Tor developers have been wary of using Namecoin to store domain names for Tor hidden services. It is also impractical to require all Tor clients to download the entire blockchain before being able to use a hidden service DNS system, and there are inherent security challenges involved with querying servers or the Namecoin network for a registration without being able to use a complete blockchain to verify it. Therefore, another solution is needed.

\section{Design Principles}

A high degree of anonymity, privacy, and security are of paramount importance for all Tor users. This context makes the inclusion of additional capabilities challenging. To meet these challenges and to remain acceptably resistant to attack, any proposed DNS system for Tor hidden services must meet at least the following requirements:

\begin{enumerate}
	\item The registrations must be anonymous; it should be infeasible to identify the registrant from the registration, including over the wire.
	\item Lookups must be anonymous; clients must stay anonymous when looking up registrations, otherwise they leak what hidden services they are interested in.
	\item Registrations must be publicly confirmable; akin to SSL certificates on the clearnet, clients must be able to verify that the registration matches and came from the service they are after, and is not a forgery.
	\item Registrations must be securely unique, or have an extremely high chance of being securely unique such as when this property relies on the collision-free property of cryptographic hashes.
	\item It must be distributed. The Tor community will adamantly reject any centralized solution for Tor hidden services for security reasons, as they have in the past for other proposals.
	\item It must remain simple to use. Most Tor users are not security experts and Tor puts almost all cryptographic details and routing details behind the scenes.
	\item It must remain backwards compatible; the existing Tor infrastructure must still remain functional.
	\item It should not be possible to maliciously modify or falsify registrations in the database or in transit, even though insider attacks.
\end{enumerate}

The current Tor hidden service protocol meets these requirements, but does not provide human-meaningful domain names so it suffers in usability. Existing literature proposing DNS systems for Tor is fairly sparse, though some ideas have been put forward. One of the most prominent is a 2011 Bachelor's thesis which outlines representing a hidden service's domain name as a series of words, rather than a base58-encoded hash.\cite{NicolussiThesis2011} However, while this scheme would improved recognition and memorability of hidden services, the words would remain random, are not chosen in advance, and do not relate to the hidden service in any meaningful way. Therefore this solution is an improvement but is not a solution. The problem remains open.

\section{Proposal}

I propose a new DNS system for Tor hidden services, which I am calling EsgalDNS. \textit{Esgal} is a Sindarin Elvish word from the works of J.R.R Tolkien, meaning "cloaked" or "hidden". EsgalDNS, as it stands currently, is a distributed DNS system embedded within the Tor network. EsgalDNS, like other DNS systems, will support several commands, including Query, Create, Modify, Move, Renew, and Delete. In my thesis I will described and implement all six commands; however in this paper I will only address Query, a registration lookup, and Create, the generation of a new registration.

One of the central elements in my system is a \textit{committee}, a set of special decision-making Tor nodes. The set of committee nodes changes every day and the set cannot be known in advance. Every hour Tor authority nodes sign and publish health and status documents about the Tor network, and both clients and Tor nodes hold an authenticated and up-to-date copy of this consensus information. A PRNG such as Mersenne Twister is seeded by a SHA256 hash of this information, and it then scrambles the list of Tor nodes. The first $ M $ nodes become the committee. Since I want the committee to remain stable for 24 hours and consensus documents are generated frequently, the PRNG will be seeded by the document published at 00:00 GMT that day. In this sense, the set of committee nodes cannot be known in advance because the future status of the network is unknowable in advance, but the current set is agreed upon by all parties who hold the consensus document, and past committees can be remembered by holding archives of these consensus documents. The committee and these properties of the committee form the basis of EsgalDNS.

At a high level, domain registrations are broadcasted through a Tor circuit to all committee nodes. Every node then analyses the registration as well as its knowledge of the chain and makes a decision. If the registration is invalid, the node rejects with an appropriate flag. If the domain name is already taken, the node returns a flag along with the pre-existing registration. Otherwise, it digitally signs its approval and the proposal itself and distributes this to the rest of the committee. It then waits for the rest of the committee votes. Since every Tor node has the up-to-date public keys of all other nodes due to the consensus documents, every committee member can verify the votes of all other committee members. Once the node confirms that all committee nodes received the same proposal and that a significant majority indicate that the domain is both valid and available, it adds the registration to its local storage. More importantly, the registration is recorded to an append-only endless scroll distributed within the Tor network. Thus domain names are consumed in a first-come-first-serve basis.

The scroll is a distributed and highly redundant chained data structure that slowly rolls through the Tor network. The scroll is $ N $ by $ M $ in shape and consists of two primary components: \textit{blocks} and \textit{captures}. Blocks contain one or more captures, and blocks are duplicated across the $ M $ committee nodes. Each capture is a collection of information from one day; it contains the consensus document from the previous morning, a list of domain registrations approved that day, the approval sign-off digital signatures from the committee nodes on those registrations, the digital signatures from the committee indicating their approval of the integrity of the scroll, and the hash of the previous four captures. In this way, captures are fully verifiable and contain enough information to link to the previous capture, forming a chain. This chain is not held by any single Tor node, rather it is encapsulated within a rolling window of blocks $ N $ days deep. As the days progress, the captures in the oldest block are migrated to the current day's block, rolling the structure forward. Thus the scroll is divided across $ N $ blocks, with copies of each block held by $ M $ Tor nodes. I consider $ N = 16, M = 64 $ reasonable values, which would involve 1,024 nodes at any given time, although $ M $ can be easily changed even while the scroll is in use.

This distributed system provides the ability to confirm a given domain name is not already in use, without relying on a single central authority. Assuming that the committee nodes are honest in their vote and trustworthy in their nature, this achieves all three properties of Zooko's Triangle. Even if the committee nodes are malicious, I believe I can introduce sufficient countermeasures to make it infeasible for an attacker to successfully manipulate the system, assuming that the majority of the Tor network is trustworthy. More research, design, and implementation is needed, but this I believe is a very promising approach.


% Each node then votes on the proposed registration. A vote consists of \textit{decision}, \textit{hash}, \textit{count}, \textit{root}, and \textit{signature} where \textit{decision} is either \textit{available}, \textit{unavailable}, or \textit{invalid}; \textit{hash} is the SHA256 of the registration it received; \textit{count} is the number of valid registrations it has in local storage; \textit{root} is the root node of the Merkle tree formed by those registrations; and \textit{signature} is the digital signature of the preceding fields.

% \textit{count} and \textit{root} will both be used to keep nodes synchronized with one another. Although I won't go into detail here, my plan calls for out-of-date nodes to attempt to synchronize with the node that advertises the highest \textit{count}. Synchronization also involves checking the votes, so falsely advertising a high \textit{count} isn't sufficient to mislead the network. \textit{root} is useful because it enables quick verification that nodes have synchronized lists and the use of a Merkle tree in general allows efficient synchronization when a node is out-of-date.


\subsection{Domain Registration}

A domain registration consists of eight components which are tied together by digital signatures and proof-of-work. The components are \textit{nonce}, \textit{consensusHash}, \textit{time}, \textit{domain}, \textit{subdomains}, \textit{contact}, \textit{digSig}, and \textit{pubKey}.

\begin{description}
	\item[nonce] \hfill \\
		An eight-byte number that serves as a source of randomness for the proof-of-work.
	\item[consensusHash] \hfill \\
		A 32-byte value containing the SHA256 hash of the consensus document published by the authority nodes. Consensus documents are generated frequently, so \textit{consensusHash} will be based on the document published at 00:00 GMT that day.
	\item[time] \hfill \\
		A four-byte integer holding the number of seconds since January 1st, 2013.
	\item[domain] \hfill \\
		A null-terminated cstring of the human-meaningful domain that will be correlated with the traditional .onion address of the hidden service. This can be up to 32 characters long. The TLD is .tor
	\item[subdomains] \hfill \\
		Up to 255 bytes of subdomain data, preceded by one byte that indicates the byte length. Each subdomain is null-terminated, so with the null characters 15 subdomains are possible when each is 16 characters long.
	\item[contact] \hfill \\
		16 bytes representing the last 32 base64-encoded bytes of the fingerprint of the service operator's PGP key, if they have one. If they do not, these bytes are zeroed. The purpose of this field is to allow the operator to be contacted securely.
	\item[digSig] \hfill \\
		The digital signature of all preceding fields.
	\item[pubKey] \hfill \\
		The public key of the hidden service.
\end{description}

To generate a registration, \textit{domain}, \textit{subdomains}, and \textit{contact} are determined by the operator, while \textit{consensusHash} and \textit{time} are filled in automatically. The hidden service operator then has to find a value for \textit{nonce} such that the proof-of-work is valid, specifically that that the SHA256 of \textit{digSig} is less than a target value \textit{T}. I plan to set \textit{T} such that the proof-of-works takes a significant amount of time on a modern CPU. This makes registering a domain expensive, thwarting flooding attacks. If \textit{nonce} is found, the registration is valid and ready for broadcast.

Two common proof-of-work systems are hashing, typically double-SHA256 ($ \textrm{SHA}256^{{2}} $) in the case of Bitcoin, and scrypt, a password-based key derivation function used by Litecoin. I chose the latter here; scrypt is a harder proof-of-work system because it requires large quantities of RAM in addition to CPU time, making brute-forcing significantly more challenging. Finding \textit{nonce} is made even more difficult because for every \textit{nonce}, a new digital signature must be made using the service's private key. This slows mining, complicates porting to GPUs and other specialized hardware, and prevents outsourcing to a outside computational resource. The digital signature ensures that all field are authenticated to the key of the hidden service, verifiable by all.

Once created and finalized, domains are broadcasted through Tor circuit(s) to committee nodes, where it can be approved and added into the scroll.

\subsection{Registration Query}

A client requesting \textit{example.tor} can use a Tor circuit to anonymously query committee nodes, or in fact any node holding the scroll, for the domain name. If the domain is taken, the client will receive the full registration (as specified above) as well as the digital signatures of the committee members who voted on that registration. This consensus and the registration itself can both be validated by the client's machine. The client can then extract \textit{pubKey} from the registration, hash it and truncate it, and look up the .onion in the traditional manner.

\section{Open Problems}

Some open problems that I need to address include:

\begin{enumerate}
	\item How frequently should domains expire? Are there any security risk in sending a Renew request?
	\item How should unreachable or temporarily down nodes be handled? I'd like to know the percentage of the Tor network that is reachable at any given time.
	\item How many nodes in the Tor network should be assumed to be actively malicious? What are the implications of increasing this percentage?
	\item What attack vectors are there from the committee nodes, and how can I thwart the attacks?
	\item What are the implications of a node intentionally voting the opposite way, or ignoring the request altogether?
	\item What would happen if a node was too slow or did not have enough storage space to do its job properly?
	\item What other open problems are there?
	\item What related works are there in the literature that relate to the concepts I have created here?
\end{enumerate}

\section{Conclusion}

This is a brief and high-level overview of EsgalDNS, a distributed DNS system inside the Tor network. The system correlates one-to-one human-meaningful domain names and traditional Tor .onion addresses. Tor nodes and clients can both verify the authenticity, integrity, and uniqueness of registrations. Although this design is nowhere near finalized, so far this system seems both promising and novel. I have more work to do, and I am planning to implement and test this system on a simulated Tor network. If accepted by the Tor community, I believe that EsgalDNS will be a valuable infrastructure that will significantly improve the usability and popularity of Tor hidden services.

\bibliographystyle{plain}
\bibliography{paper}

\end{document}
